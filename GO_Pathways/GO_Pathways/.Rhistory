names(pathway_scores) <- gsea_res$Description
# --- Sanity check before UMAP ---
cat("Number of KEGG pathways:", nrow(weighted_mat), "\n")
cat("Number of overlapping genes:", length(common_genes), "\n")
if (nrow(weighted_mat) == 0 | ncol(weighted_mat) == 0) {
stop("Error: No overlapping genes/pathways found. Check gene ID formats (Entrez vs SYMBOL).")
}
# --- Run UMAP ---
set.seed(123)
umap_res <- umap(weighted_mat)
umap_df <- data.frame(umap_res$layout) %>%
rownames_to_column("Pathway") %>%
mutate(NES = pathway_scores[Pathway],
Direction = ifelse(NES > 0, "Upregulated", "Downregulated"))
# --- Plot 2D UMAP ---
ggplot(umap_df, aes(x = X1, y = X2, color = NES)) +
geom_point(size = 3, alpha = 0.9) +
scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
theme_minimal(base_size = 14) +
labs(
title = "2D UMAP of KEGG Pathways Based on GSEA (gseKEGG)",
subtitle = "Pathways positioned by similarity of DEG profiles; NES color indicates direction",
color = "Normalized Enrichment Score (NES)"
)
# Create an output data frame
umap_export <- umap_df %>%
dplyr::select(Pathway, X1, X2, mean_log2FC) %>%
arrange(desc(mean_log2FC))
# ============================================
# 2D UMAP of KEGG Pathways Based on DEG GSEA (gseKEGG)
# ============================================
library(clusterProfiler)
library(org.Hs.eg.db)
library(dplyr)
library(ggplot2)
library(umap)
library(tibble)
library(enrichplot)
library(openxlsx)
# --- User input: your DEG CSV file ---
deg <- read.csv("Nadine_GBS_3Col.csv")
# Standardize column names
colnames(deg) <- tolower(colnames(deg))
colnames(deg)[colnames(deg) == "gene_name"] <- "gene"
colnames(deg)[colnames(deg) == "log2foldchange"] <- "log2fc"
# --- Convert gene symbols to Entrez IDs (for KEGG) ---
deg$entrez <- mapIds(org.Hs.eg.db,
keys = deg$gene,
keytype = "SYMBOL",
column = "ENTREZID",
multiVals = "first")
deg <- deg %>% filter(!is.na(entrez))
# --- Prepare ranked gene list for GSEA ---
gene_list <- deg$log2fc
names(gene_list) <- deg$entrez
gene_list <- sort(gene_list, decreasing = TRUE)
# --- Run GSEA KEGG ---
gsea_kegg <- gseKEGG(
geneList     = gene_list,
organism     = 'hsa',
pvalueCutoff = 0.05,
verbose      = FALSE
)
# --- Extract results ---
gsea_res <- as.data.frame(gsea_kegg@result)
cat("Number of significant KEGG pathways:", nrow(gsea_res), "\n")
# --- Build pathway × gene score matrix ---
# Each pathway has a gene set -> extract from core enrichment genes
kegg2gene <- strsplit(gsea_res$core_enrichment, "/")
names(kegg2gene) <- gsea_res$Description
genes <- unique(unlist(kegg2gene))
pathway_matrix <- matrix(0, nrow = length(kegg2gene), ncol = length(genes),
dimnames = list(names(kegg2gene), genes))
for (i in seq_along(kegg2gene)) {
pathway_matrix[i, kegg2gene[[i]]] <- 1
}
# Map log2FC values to Entrez IDs
fc_map <- deg$log2fc
names(fc_map) <- deg$entrez
# Compute weighted pathway signatures
common_genes <- intersect(colnames(pathway_matrix), names(fc_map))
pathway_matrix <- pathway_matrix[, common_genes, drop = FALSE]
weighted_mat <- sweep(pathway_matrix, 2, fc_map[common_genes], "*")
# --- Use NES (Normalized Enrichment Score) for coloring ---
pathway_scores <- gsea_res$NES
names(pathway_scores) <- gsea_res$Description
# --- Sanity check before UMAP ---
cat("Number of KEGG pathways:", nrow(weighted_mat), "\n")
cat("Number of overlapping genes:", length(common_genes), "\n")
if (nrow(weighted_mat) == 0 | ncol(weighted_mat) == 0) {
stop("Error: No overlapping genes/pathways found. Check gene ID formats (Entrez vs SYMBOL).")
}
# --- Run UMAP ---
set.seed(123)
umap_res <- umap(weighted_mat)
umap_df <- data.frame(umap_res$layout) %>%
rownames_to_column("Pathway") %>%
mutate(NES = pathway_scores[Pathway],
Direction = ifelse(NES > 0, "Upregulated", "Downregulated"))
# --- Plot 2D UMAP ---
ggplot(umap_df, aes(x = X1, y = X2, color = NES)) +
geom_point(size = 3, alpha = 0.9) +
scale_color_gradient2(low = "blue", mid = "white", high = "red", midpoint = 0) +
theme_minimal(base_size = 14) +
labs(
title = "2D UMAP of KEGG Pathways Based on GSEA (gseKEGG)",
subtitle = "Pathways positioned by similarity of DEG profiles; NES color indicates direction",
color = "Normalized Enrichment Score (NES)"
)
# Create an output data frame for export
umap_export <- umap_df %>%
dplyr::select(Pathway, X1, X2, NES, Direction) %>%
arrange(desc(NES))
# Save to Excel
output_file <- "KEGG_UMAP_Pathway_Coordinates.xlsx"
write.xlsx(umap_export, file = output_file, row.names = FALSE)
cat("✅ UMAP pathway coordinates exported to:", output_file, "\n")
library(pathview)
library(clusterProfiler)
library(org.Hs.eg.db)
library(biomaRt)
library(dplyr)
library(KEGGREST)
# 2. Load your DEG data
deg <- read.csv("Nadine_GBS_3Col.csv")  # columns: symbol, log2FC, pvalue
# Standardize column names
colnames(deg) <- tolower(colnames(deg))
colnames(deg) <- c("symbol", "log2FC", "pvalue")
# Convert gene symbols to Entrez IDs (required by KEGG)
deg_entrez <- bitr(deg$symbol,
fromType = "SYMBOL",
toType = "ENTREZID",
OrgDb = org.Hs.eg.db)
# Merge back to main DEG data
deg_merged <- merge(deg, deg_entrez, by.x = "symbol", by.y = "SYMBOL")
# 3. Prepare input vector for Pathview
gene_data <- deg_merged$log2FC
names(gene_data) <- deg_merged$ENTREZID
# 4. Define pathway info
pathway_id <- "hsa03040"
pathway_info <- keggGet(pathway_id)[[1]]
pathway_name <- gsub(" ", "_", pathway_info$NAME)  # replace spaces with underscores
# 5. Create folder for pathway outputs
if(!dir.exists(pathway_name)) dir.create(pathway_name)
# 6. Run Pathview for the full pathway, output goes into folder
pathview(
gene.data = gene_data,
pathway.id = pathway_id,
species = "hsa",
kegg.native = TRUE,
same.layer = TRUE,
limit = list(gene = c(-3.5, 3.5)),
low = list(gene = "blue"),
mid = list(gene = "white"),
high = list(gene = "red"),
out.suffix = "Response_to_estrogen",
out.dir = pathway_name  # save PNG/PDF in folder
)
# 7. Export KEGG gene mapping with DEG info
kegg_genes <- pathway_info$GENE
kegg_df <- data.frame(
entrez_id = kegg_genes[seq(1, length(kegg_genes), 2)],
info = kegg_genes[seq(2, length(kegg_genes), 2)],
stringsAsFactors = FALSE
)
kegg_df$symbol <- sapply(strsplit(kegg_df$info, ";"), `[`, 1)
kegg_df$desc <- sapply(strsplit(kegg_df$info, "; "), `[`, 2)
deg_kegg <- left_join(kegg_df, deg_merged, by = c("symbol" = "symbol"))
deg_kegg_present <- deg_kegg[!is.na(deg_kegg$log2FC), ]
write.table(deg_kegg_present,
file = file.path(pathway_name, "KEGG_pathway_gene_mapping.txt"),
sep = "\t",
row.names = FALSE,
quote = FALSE)
cat("KEGG pathway gene mapping exported to", file.path(pathway_name, "KEGG_pathway_gene_mapping.txt"), "\n")
# 8. Optional: restrict to only subset genes
pathway_genes <- c("GATA3","SERPINB9","PELP1","KMT2D","RARA","WBP2","ESR2",
"EP300","ARID5A","BRCA1","ESR1","ASH2L","KRT19","BCAS3")
deg_subset <- deg_merged[deg_merged$symbol %in% pathway_genes, ]
gene_data_subset <- deg_subset$log2FC
names(gene_data_subset) <- deg_subset$ENTREZID
pathview(
gene.data = gene_data_subset,
pathway.id = pathway_id,
species = "hsa",
kegg.native = TRUE,
limit = list(gene = c(-3.5, 3.5)),
low = list(gene = "blue"),
mid = list(gene = "white"),
high = list(gene = "red"),
out.suffix = "Response_to_estrogen_subset",
out.dir = pathway_name  # save PNG/PDF in folder
)
library(pathview)
library(clusterProfiler)
library(org.Hs.eg.db)
library(biomaRt)
library(dplyr)
library(KEGGREST)
# 2. Load your DEG data
deg <- read.csv("Nadine_GBS_3Col.csv")  # columns: symbol, log2FC, pvalue
# Standardize column names
colnames(deg) <- tolower(colnames(deg))
colnames(deg) <- c("symbol", "log2FC", "pvalue")
# Convert gene symbols to Entrez IDs (required by KEGG)
deg_entrez <- bitr(deg$symbol,
fromType = "SYMBOL",
toType = "ENTREZID",
OrgDb = org.Hs.eg.db)
# Merge back to main DEG data
deg_merged <- merge(deg, deg_entrez, by.x = "symbol", by.y = "SYMBOL")
# 3. Prepare input vector for Pathview
gene_data <- deg_merged$log2FC
names(gene_data) <- deg_merged$ENTREZID
# 4. Define pathway info
pathway_id <- "hsa04330"
pathway_info <- keggGet(pathway_id)[[1]]
pathway_name <- gsub(" ", "_", pathway_info$NAME)  # replace spaces with underscores
# 5. Create folder for pathway outputs
if(!dir.exists(pathway_name)) dir.create(pathway_name)
# 6. Run Pathview for the full pathway, output goes into folder
pathview(
gene.data = gene_data,
pathway.id = pathway_id,
species = "hsa",
kegg.native = TRUE,
same.layer = TRUE,
limit = list(gene = c(-3.5, 3.5)),
low = list(gene = "blue"),
mid = list(gene = "white"),
high = list(gene = "red"),
out.suffix = "Response_to_estrogen",
out.dir = pathway_name  # save PNG/PDF in folder
)
# 7. Export KEGG gene mapping with DEG info
kegg_genes <- pathway_info$GENE
kegg_df <- data.frame(
entrez_id = kegg_genes[seq(1, length(kegg_genes), 2)],
info = kegg_genes[seq(2, length(kegg_genes), 2)],
stringsAsFactors = FALSE
)
kegg_df$symbol <- sapply(strsplit(kegg_df$info, ";"), `[`, 1)
kegg_df$desc <- sapply(strsplit(kegg_df$info, "; "), `[`, 2)
deg_kegg <- left_join(kegg_df, deg_merged, by = c("symbol" = "symbol"))
deg_kegg_present <- deg_kegg[!is.na(deg_kegg$log2FC), ]
write.table(deg_kegg_present,
file = file.path(pathway_name, "KEGG_pathway_gene_mapping.txt"),
sep = "\t",
row.names = FALSE,
quote = FALSE)
cat("KEGG pathway gene mapping exported to", file.path(pathway_name, "KEGG_pathway_gene_mapping.txt"), "\n")
# 8. Optional: restrict to only subset genes
pathway_genes <- c("GATA3","SERPINB9","PELP1","KMT2D","RARA","WBP2","ESR2",
"EP300","ARID5A","BRCA1","ESR1","ASH2L","KRT19","BCAS3")
deg_subset <- deg_merged[deg_merged$symbol %in% pathway_genes, ]
gene_data_subset <- deg_subset$log2FC
names(gene_data_subset) <- deg_subset$ENTREZID
pathview(
gene.data = gene_data_subset,
pathway.id = pathway_id,
species = "hsa",
kegg.native = TRUE,
limit = list(gene = c(-3.5, 3.5)),
low = list(gene = "blue"),
mid = list(gene = "white"),
high = list(gene = "red"),
out.suffix = "Response_to_estrogen_subset",
out.dir = pathway_name  # save PNG/PDF in folder
)
library(pathview)
library(clusterProfiler)
library(org.Hs.eg.db)
library(biomaRt)
library(dplyr)
library(KEGGREST)
# 2. Load your DEG data
deg <- read.csv("Nadine_GBS_3Col.csv")  # columns: symbol, log2FC, pvalue
# Standardize column names
colnames(deg) <- tolower(colnames(deg))
colnames(deg) <- c("symbol", "log2FC", "pvalue")
# Convert gene symbols to Entrez IDs (required by KEGG)
deg_entrez <- bitr(deg$symbol,
fromType = "SYMBOL",
toType = "ENTREZID",
OrgDb = org.Hs.eg.db)
# Merge back to main DEG data
deg_merged <- merge(deg, deg_entrez, by.x = "symbol", by.y = "SYMBOL")
# 3. Prepare input vector for Pathview
gene_data <- deg_merged$log2FC
names(gene_data) <- deg_merged$ENTREZID
# 4. Define pathway info
pathway_id <- "hsa04010"
pathway_info <- keggGet(pathway_id)[[1]]
pathway_name <- gsub(" ", "_", pathway_info$NAME)  # replace spaces with underscores
# 5. Create folder for pathway outputs
if(!dir.exists(pathway_name)) dir.create(pathway_name)
# 6. Run Pathview for the full pathway, output goes into folder
pathview(
gene.data = gene_data,
pathway.id = pathway_id,
species = "hsa",
kegg.native = TRUE,
same.layer = TRUE,
limit = list(gene = c(-3.5, 3.5)),
low = list(gene = "blue"),
mid = list(gene = "white"),
high = list(gene = "red"),
out.suffix = "Response_to_estrogen",
out.dir = pathway_name  # save PNG/PDF in folder
)
# 7. Export KEGG gene mapping with DEG info
kegg_genes <- pathway_info$GENE
kegg_df <- data.frame(
entrez_id = kegg_genes[seq(1, length(kegg_genes), 2)],
info = kegg_genes[seq(2, length(kegg_genes), 2)],
stringsAsFactors = FALSE
)
kegg_df$symbol <- sapply(strsplit(kegg_df$info, ";"), `[`, 1)
kegg_df$desc <- sapply(strsplit(kegg_df$info, "; "), `[`, 2)
deg_kegg <- left_join(kegg_df, deg_merged, by = c("symbol" = "symbol"))
deg_kegg_present <- deg_kegg[!is.na(deg_kegg$log2FC), ]
write.table(deg_kegg_present,
file = file.path(pathway_name, "KEGG_pathway_gene_mapping.txt"),
sep = "\t",
row.names = FALSE,
quote = FALSE)
cat("KEGG pathway gene mapping exported to", file.path(pathway_name, "KEGG_pathway_gene_mapping.txt"), "\n")
# 8. Optional: restrict to only subset genes
pathway_genes <- c("GATA3","SERPINB9","PELP1","KMT2D","RARA","WBP2","ESR2",
"EP300","ARID5A","BRCA1","ESR1","ASH2L","KRT19","BCAS3")
deg_subset <- deg_merged[deg_merged$symbol %in% pathway_genes, ]
gene_data_subset <- deg_subset$log2FC
names(gene_data_subset) <- deg_subset$ENTREZID
pathview(
gene.data = gene_data_subset,
pathway.id = pathway_id,
species = "hsa",
kegg.native = TRUE,
limit = list(gene = c(-3.5, 3.5)),
low = list(gene = "blue"),
mid = list(gene = "white"),
high = list(gene = "red"),
out.suffix = "Response_to_estrogen_subset",
out.dir = pathway_name  # save PNG/PDF in folder
)
# =========================================
# Multi-pathway heatmap with mean log2FC per pathway
# =========================================
library(dplyr)
library(pheatmap)
library(RColorBrewer)
# -------------------------------
# 1. Load DEG data
# -------------------------------
deg <- read.csv("Nadine_GBS_3Col.csv")  # columns: symbol, log2FC, pvalue
colnames(deg) <- tolower(colnames(deg))
colnames(deg) <- c("symbol", "log2FC", "pvalue")
# Create a named vector for fast lookup
deg_lookup <- setNames(deg$log2FC, deg$symbol)
# -------------------------------
# 2. Load pathways from CSV
# -------------------------------
# Assuming your CSV has 2 columns: Pathway_name, Genes
pathway_df <- read.csv("heatmap.csv", stringsAsFactors = FALSE, header = FALSE)
colnames(pathway_df) <- c("Pathway", "Genes")
# Convert comma-separated gene strings into vectors
pathways <- setNames(
lapply(pathway_df$Genes, function(x) strsplit(x, ",")[[1]]),
pathway_df$Pathway
)
# -------------------------------
# 3. Compute mean log2FC per pathway
# -------------------------------
pathway_means <- sapply(pathways, function(genes) {
mean(deg_lookup[genes], na.rm = TRUE)
})
# Convert to a matrix for heatmap (1 column)
heat_matrix <- matrix(pathway_means, ncol = 1)
rownames(heat_matrix) <- names(pathway_means)
colnames(heat_matrix) <- "Mean_log2FC"
# -------------------------------
# 4. Create diverging color palette centered at 0
# -------------------------------
max_val <- max(abs(heat_matrix), na.rm = TRUE)
breaks <- seq(-max_val, max_val, length.out = 51)
colors <- colorRampPalette(c("blue", "white", "red"))(50)
# -------------------------------
# 5. Plot heatmap
# -------------------------------
pheatmap(
heat_matrix,
color = colors,
breaks = breaks,
cluster_rows = TRUE,
cluster_cols = FALSE,
main = "Mean log2FC per Pathway",
fontsize_row = 8,
fontsize_col = 10
)
# =========================================
# Multi-pathway heatmap with mean log2FC per pathway
# =========================================
library(dplyr)
library(pheatmap)
library(RColorBrewer)
# -------------------------------
# 1. Load DEG data
# -------------------------------
deg <- read.csv("Nadine_GBS_3Col.csv")  # columns: symbol, log2FC, pvalue
colnames(deg) <- tolower(colnames(deg))
colnames(deg) <- c("symbol", "log2FC", "pvalue")
# Create a named vector for fast lookup
deg_lookup <- setNames(deg$log2FC, deg$symbol)
# -------------------------------
# 2. Load pathways from CSV
# -------------------------------
# Assuming your CSV has 2 columns: Pathway_name, Genes
pathway_df <- read.csv("heatmap.csv", stringsAsFactors = FALSE, header = FALSE)
colnames(pathway_df) <- c("Pathway", "Genes")
# Convert comma-separated gene strings into vectors
pathways <- setNames(
lapply(pathway_df$Genes, function(x) strsplit(x, ",")[[1]]),
pathway_df$Pathway
)
# -------------------------------
# 3. Compute mean log2FC per pathway
# -------------------------------
pathway_means <- sapply(pathways, function(genes) {
mean(deg_lookup[genes], na.rm = TRUE)
})
# Convert to a matrix for heatmap (1 column)
heat_matrix <- matrix(pathway_means, ncol = 1)
rownames(heat_matrix) <- names(pathway_means)
colnames(heat_matrix) <- "Mean_log2FC"
# -------------------------------
# 4. Create diverging color palette centered at 0
# -------------------------------
max_val <- max(abs(heat_matrix), na.rm = TRUE)
breaks <- seq(-max_val, max_val, length.out = 51)
colors <- colorRampPalette(c("blue", "white", "red"))(50)
# -------------------------------
# 5. Plot heatmap
# -------------------------------
pheatmap(
heat_matrix,
color = colors,
breaks = breaks,
cluster_rows = TRUE,
cluster_cols = FALSE,
main = "Mean log2FC per Pathway",
fontsize_row = 4,
fontsize_col = 10
)
# =========================================
# Multi-pathway heatmap from user-defined pathways
# =========================================
library(dplyr)
library(pheatmap)
library(RColorBrewer)
# -------------------------------
# 1. Load DEG data
# -------------------------------
deg <- read.csv("Nadine_GBS_3Col.csv")  # columns: symbol, log2FC, pvalue
colnames(deg) <- tolower(colnames(deg))
colnames(deg) <- c("symbol", "log2FC", "pvalue")
# Create a named vector for fast lookup
deg_lookup <- setNames(deg$log2FC, deg$symbol)
# -------------------------------
# 2. Load pathways from CSV
# -------------------------------
# Assuming your CSV has 2 columns: Pathway_name, Genes
pathway_df <- read.csv("heatmap.csv", stringsAsFactors = FALSE, header = FALSE)
colnames(pathway_df) <- c("Pathway", "Genes")
# Convert comma-separated gene strings into vectors
pathways <- setNames(
lapply(pathway_df$Genes, function(x) strsplit(x, ",")[[1]]),
pathway_df$Pathway
)
# -------------------------------
# 3. Build a heatmap matrix
# -------------------------------
all_genes <- unique(unlist(pathways))  # all genes across pathways
heat_matrix <- matrix(NA, nrow = length(pathways), ncol = length(all_genes))
rownames(heat_matrix) <- names(pathways)
colnames(heat_matrix) <- all_genes
# Fill in log2FC values
for(pw in names(pathways)){
genes <- pathways[[pw]]
heat_matrix[pw, genes] <- deg_lookup[genes]
}
# Optional: replace NA with 0 if you want missing genes to appear white
heat_matrix_filled <- heat_matrix
heat_matrix_filled[is.na(heat_matrix_filled)] <- 0
# -------------------------------
# 4. Create diverging color palette centered at 0
# -------------------------------
max_val <- max(abs(heat_matrix_filled), na.rm = TRUE)
breaks <- seq(-max_val, max_val, length.out = 51)
colors <- colorRampPalette(c("blue", "white", "red"))(50)
# -------------------------------
# 5. Plot heatmap
# -------------------------------
pheatmap(
heat_matrix_filled,
color = colors,
breaks = breaks,
cluster_cols = TRUE,
cluster_rows = TRUE,
main = "Multi-pathway Heatmap (log2FC)",
fontsize_row = 4,
fontsize_col = 4
)
